<!DOCTYPE html>
<html>
<head>
  <title>Reliable PeerJS Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body { background:#0f172a; color:#fff; font-family:Arial; text-align:center; padding:10px; }
    h2 { margin-top:5px; }
    video { width:45%; border-radius:12px; margin:5px; background:black; }
    input { padding:10px; border-radius:6px; border:none; }
    .controls button { padding:10px 14px; margin:5px; border:none; border-radius:8px; cursor:pointer; }
    .end { background:#ef4444; }
    .mute { background:#64748b; }
    .cam { background:#3b82f6; }
    #userList { margin-top:10px; }
    .user { cursor:pointer; margin:5px; padding:5px; background:#334155; border-radius:6px; display:inline-block; }
    .status { margin:10px; color:#38bdf8; }
  </style>
</head>
<body>

<h2>ğŸ“ Video Call with Firebase Users</h2>

<input id="username" placeholder="Enter your username">
<button id="setNameBtn">Set Username</button>
<p>Your username: <b id="myId">Not set</b></p>

<div id="userList"><b>Online Users:</b></div>

<div class="controls">
  <button class="end" id="endBtn">âŒ End Call</button>
  <button class="mute" id="muteBtn">ğŸ”‡ Mute</button>
  <button class="cam" id="camBtn">ğŸ¥ Camera</button>
</div>

<p class="status" id="status">Status: Idle</p>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// ====== FIREBASE INIT ======
const firebaseConfig = {
  apiKey: "AIzaSyDoabY1ksPwyZ0frzf5ll3yq6n4LZDT7z4",
  authDomain: "video-app-7ace2.firebaseapp.com",
  databaseURL: "https://video-app-7ace2-default-rtdb.firebaseio.com",
  projectId: "video-app-7ace2",
  storageBucket: "video-app-7ace2.appspot.com",
  messagingSenderId: "1006315639241",
  appId: "1:1006315639241:web:de262b95e926484acd5818"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== GLOBALS ======
let peer;
let localStream;
let currentCall;
let micOn = true;
let camOn = true;
let myUsername = "";
let myPeerId = "";

// ====== UI ELEMENTS ======
const myIdEl = document.getElementById("myId");
const statusEl = document.getElementById("status");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const userListDiv = document.getElementById("userList");

// ====== SET USERNAME ======
document.getElementById("setNameBtn").onclick = async () => {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("Enter a username!");
  myUsername = name;

  // Generate unique PeerJS ID
  myPeerId = myUsername + "_" + Math.floor(Math.random()*10000);

  // Destroy previous peer if exists
  if (peer) peer.destroy();

  // ====== PEERJS WITH TURN/STUN ======
  peer = new Peer(myPeerId, {
    host: '0.peerjs.com', 
    port: 443, 
    path: '/',
    secure: true,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'turn:numb.viagenie.ca', credential: 'muazkh', username: 'webrtc@live.com' }
      ]
    },
    debug: 2
  });

  // ====== ON OPEN ======
  peer.on('open', id => {
    myIdEl.innerText = myUsername + " (" + id + ")";
    statusEl.innerText = "Status: Ready";

    // Register in Firebase
    set(ref(db, "users/" + myUsername), { peerId: id });

    // Remove on unload
    window.addEventListener("beforeunload", () => remove(ref(db, "users/" + myUsername)));
  });

  // ====== CAMERA & MIC ======
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  localVideo.srcObject = localStream;

  // ====== INCOMING CALL ======
  peer.on("call", call => {
    currentCall = call;
    call.answer(localStream);
    statusEl.innerText = "Status: In call with " + call.peer;
    call.on("stream", stream => remoteVideo.srcObject = stream);
    call.on("close", () => endCall());
  });

  // ====== ONLINE USERS LIST ======
  onValue(ref(db, "users"), snapshot => {
    userListDiv.innerHTML = "<b>Online Users:</b> ";
    snapshot.forEach(child => {
      const uname = child.key;
      const peerId = child.val().peerId;
      if (uname !== myUsername) {
        const div = document.createElement("div");
        div.innerText = uname;
        div.className = "user";
        div.onclick = () => callUser(peerId, uname);
        userListDiv.appendChild(div);
      }
    });
  });
};

// ====== CALL USER ======
function callUser(targetPeerId, targetName) {
  if (!peer || !localStream) return alert("Set username and allow camera/mic first");
  currentCall = peer.call(targetPeerId, localStream);
  statusEl.innerText = "Status: Calling " + targetName;

  currentCall.on("stream", stream => {
    remoteVideo.srcObject = stream;
    statusEl.innerText = "Status: In call with " + targetName;
  });

  currentCall.on("close", () => endCall());
}

// ====== END CALL ======
function endCall() {
  if (currentCall) currentCall.close();
  remoteVideo.srcObject = null;
  statusEl.innerText = "Status: Call ended";
}

// ====== MUTE / UNMUTE ======
document.getElementById("muteBtn").onclick = () => {
  micOn = !micOn;
  if (localStream) localStream.getAudioTracks()[0].enabled = micOn;
  statusEl.innerText = micOn ? "Mic ON" : "Mic MUTED";
};

// ====== CAMERA ON / OFF ======
document.getElementById("camBtn").onclick = () => {
  camOn = !camOn;
  if (localStream) localStream.getVideoTracks()[0].enabled = camOn;
  statusEl.innerText = camOn ? "Camera ON" : "Camera OFF";
};

// ====== END CALL BUTTON ======
document.getElementById("endBtn").onclick = endCall;

</script>

</body>
</html>
