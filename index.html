<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Direct Multi-User Video Call</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f0f0;margin:0;padding:0;}
#controls{margin:20px;}
#videos{display:flex;flex-wrap:wrap;justify-content:center;margin-top:10px;}
.video-container{margin:10px;display:flex;flex-direction:column;align-items:center;}
video{width:300px;border-radius:8px;border:2px solid #333;}
label{margin-top:5px;font-weight:bold;}
input,button{padding:8px 12px;margin:5px;font-size:16px;}
#participants{margin-top:10px;text-align:left;display:inline-block;max-width:300px;}
#chat{border:1px solid #ccc;padding:10px;width:300px;height:200px;overflow-y:auto;margin:10px auto;background:#fff;text-align:left;}
#chat-input{width:200px;}
</style>
</head>
<body>
<h2>Direct Multi-User Video Call</h2>

<div id="controls">
<input type="text" id="name-input" placeholder="Your name">
<button id="join-btn">Join Call</button>
</div>

<div id="buttons" style="display:none;">
<button id="mute-btn">Mute</button>
<button id="leave-btn">Leave Call</button>
</div>

<div id="participants"><h3>Online:</h3><ul id="participants-list"></ul></div>

<div id="videos"></div>

<div id="chat">
<div id="messages"></div>
</div>
<input type="text" id="chat-input" placeholder="Type message">
<button id="send-btn">Send</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const joinBtn = document.getElementById('join-btn');
const nameInput = document.getElementById('name-input');
const videosDiv = document.getElementById('videos');
const muteBtn = document.getElementById('mute-btn');
const leaveBtn = document.getElementById('leave-btn');
const buttonsDiv = document.getElementById('buttons');
const participantsList = document.getElementById('participants-list');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const messagesDiv = document.getElementById('messages');

let myStream;
let socket;
let peers = {};
let myName;
let muted = false;

// Video
function createVideo(id, name, stream){
  if(document.getElementById('video-'+id)) return;
  const container=document.createElement('div');
  container.className='video-container';
  container.id='video-'+id;
  const video=document.createElement('video');
  video.autoplay=true;
  video.playsInline=true;
  video.srcObject=stream;
  if(id==='self') video.muted=true;
  const label=document.createElement('label');
  label.innerText=name;
  container.appendChild(video);
  container.appendChild(label);
  videosDiv.appendChild(container);
}

// Remove video
function removeVideo(id){
  const container=document.getElementById('video-'+id);
  if(container) container.remove();
}

// Add participant
function addParticipant(name, id){
  if(document.getElementById('p-'+id)) return;
  const li=document.createElement('li');
  li.id='p-'+id;
  li.innerText=name;
  participantsList.appendChild(li);
}

// Remove participant
function removeParticipant(id){
  const li=document.getElementById('p-'+id);
  if(li) li.remove();
}

// Chat
function addMessage(name,text){
  const div=document.createElement('div');
  div.innerHTML='<b>'+name+':</b> '+text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// Get media
async function getMedia(){
  myStream=await navigator.mediaDevices.getUserMedia({video:{width:320,height:240},audio:true});
  createVideo('self',myName,myStream);
}

// Join
joinBtn.addEventListener('click', async ()=>{
  myName=nameInput.value.trim();
  if(!myName) return alert("Enter your name");
  await getMedia();
  buttonsDiv.style.display='block';
  socket=io();
  socket.emit('join',myName);

  // Update participant list
  socket.on('users',users=>{
    participantsList.innerHTML='';
    videosDiv.innerHTML='<div id="video-self" class="video-container"><video autoplay playsinline muted></video><label>'+myName+'</label></div>';
    const selfVideo=document.querySelector('#video-self video');
    selfVideo.srcObject=myStream;
    for(const id in users){
      if(id===socket.id) continue;
      addParticipant(users[id],id);
      // Call new users
      const pc = new RTCPeerConnection();
      myStream.getTracks().forEach(track=>pc.addTrack(track,myStream));
      pc.ontrack=event=>createVideo(id,users[id],event.streams[0]);
      pc.onicecandidate=event=>{if(event.candidate) socket.emit('signal',{to:id,signal:JSON.stringify(event.candidate)});}
      peers[id]=pc;
      pc.createOffer().then(offer=>pc.setLocalDescription(offer).then(()=>{socket.emit('signal',{to:id,signal:JSON.stringify(pc.localDescription)});})).catch(console.error);
    }
  });

  // Receive signaling
  socket.on('signal',async data=>{
    let pc=peers[data.from];
    if(!pc){
      pc=new RTCPeerConnection();
      myStream.getTracks().forEach(track=>pc.addTrack(track,myStream));
      pc.ontrack=event=>createVideo(data.from,'User',event.streams[0]);
      pc.onicecandidate=event=>{if(event.candidate) socket.emit('signal',{to:data.from,signal:JSON.stringify(event.candidate)});}
      peers[data.from]=pc;
    }
    const signal=JSON.parse(data.signal);
    if(signal.type==='offer'){
      await pc.setRemoteDescription(signal);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('signal',{to:data.from,signal:JSON.stringify(pc.localDescription)});
    }else if(signal.type==='answer'){
      await pc.setRemoteDescription(signal);
    }else{
      await pc.addIceCandidate(signal);
    }
  });

  // Chat
  socket.on('chat',msg=>addMessage(msg.name,msg.text));
});

// Mute
muteBtn.addEventListener('click',()=>{
  muted=!muted;
  myStream.getAudioTracks()[0].enabled=!muted;
  muteBtn.innerText=muted?'Unmute':'Mute';
});

// Leave
leaveBtn.addEventListener('click',()=>{
  socket.disconnect();
  videosDiv.innerHTML='';
  participantsList.innerHTML='';
  messagesDiv.innerHTML='';
  buttonsDiv.style.display='none';
  peers={};
  alert("You left the call");
});

// Send chat
sendBtn.addEventListener('click',()=>{
  const text=chatInput.value.trim();
  if(!text) return;
  addMessage(myName,text);
  socket.emit('chat',text);
  chatInput.value='';
});
</script>
</body>
</html>
