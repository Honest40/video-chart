<!DOCTYPE html>
<html>
<head>
  <title>PeerJS Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PeerJS CDN -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body { background:#111; color:#fff; text-align:center; font-family:Arial; }
    video { width:45%; margin:5px; background:black; border-radius:10px; }
    input, button { padding:10px; margin:5px; font-size:16px; }
  </style>
</head>
<body>

<h2>ðŸŽ¥ PeerJS Video & Audio Call</h2>

<input id="username" placeholder="Enter your username">
<button id="setNameBtn">Set Username</button>

<p>Your ID: <b id="myId">Not set</b></p>

<input id="callId" placeholder="Enter username to call">
<button onclick="callUser()">Call</button>

<br><br>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script>
let peer;
let localStream;
let myUsername;
let peerMap = {}; // maps username -> peerId (optional if you use Firebase later)

// ===== Get camera & mic =====
async function initCamera() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById("localVideo").srcObject = localStream;
  } catch(err) {
    alert("Camera error: " + err);
  }
}

// ===== Set username & PeerJS ID =====
document.getElementById("setNameBtn").onclick = () => {
  myUsername = document.getElementById("username").value.trim();
  if (!myUsername) return alert("Enter a username");

  // Create unique PeerJS ID using username
  const uniqueId = myUsername + "_" + Math.floor(Math.random()*10000);

  // Destroy previous peer if exists
  if (peer) peer.destroy();

  peer = new Peer(uniqueId, {
    debug: 2,
    config: {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "turn:numb.viagenie.ca", credential: "muazkh", username: "webrtc@live.com" }
      ]
    }
  });

  peer.on("open", id => {
    document.getElementById("myId").innerText = id;
  });

  // ===== Answer incoming calls =====
  peer.on("call", call => {
    call.answer(localStream);
    call.on("stream", stream => {
      document.getElementById("remoteVideo").srcObject = stream;
    });
  });
};

// ===== Call another user =====
function callUser() {
  const target = document.getElementById("callId").value.trim();
  if (!target) return alert("Enter a username to call");
  if (!localStream) return alert("Camera not ready");
  
  // For now, assume target uses same pattern: username_random
  // In real app, youâ€™d use Firebase to map username -> PeerJS ID
  const targetId = prompt("Enter full PeerJS ID of " + target + " (e.g., username_1234)");
  if (!targetId) return;

  const call = peer.call(targetId, localStream);
  call.on("stream", stream => {
    document.getElementById("remoteVideo").srcObject = stream;
  });
}

// Initialize camera on load
initCamera();
</script>

</body>
</html>
