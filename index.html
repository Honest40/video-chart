<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Multi-User Video Call</title>
<style>
body { font-family: Arial; text-align: center; background: #f0f0f0; margin:0; padding:0; }
#controls { margin: 20px; }
#videos { display: flex; flex-wrap: wrap; justify-content: center; }
.video-container { position: relative; margin: 10px; display: flex; flex-direction: column; align-items: center; }
video { width: 300px; border-radius: 8px; border: 2px solid #333; }
label { margin-top: 5px; font-weight: bold; }
button, input { padding: 8px 12px; margin: 5px; font-size: 16px; }
#buttons { margin-top: 10px; }
</style>
</head>
<body>
<h2>Advanced Multi-User Video Call</h2>

<div id="controls">
  <input type="text" id="name-input" placeholder="Your name">
  <input type="text" id="room-input" placeholder="Room name">
  <button id="join-btn">Join Room</button>
</div>

<div id="buttons" style="display:none;">
  <button id="mute-btn">Mute</button>
  <button id="leave-btn">Leave Room</button>
</div>

<div id="videos"></div>

<!-- PeerJS CDN -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const joinBtn = document.getElementById('join-btn');
const nameInput = document.getElementById('name-input');
const roomInput = document.getElementById('room-input');
const videosDiv = document.getElementById('videos');
const muteBtn = document.getElementById('mute-btn');
const leaveBtn = document.getElementById('leave-btn');
const buttonsDiv = document.getElementById('buttons');

let myStream;
let myPeer;
let myPeerId;
let myName;
let peers = {};
let muted = false;

// Create video element with label
function createVideo(id, name, stream) {
  const container = document.createElement('div');
  container.className = 'video-container';
  container.id = 'container-' + id;

  const video = document.createElement('video');
  video.autoplay = true;
  video.playsInline = true;
  video.srcObject = stream;
  if(id === myPeerId) video.muted = true;

  const label = document.createElement('label');
  label.innerText = name;

  container.appendChild(video);
  container.appendChild(label);
  videosDiv.appendChild(container);
}

// Remove video
function removeVideo(id) {
  const container = document.getElementById('container-' + id);
  if(container) container.remove();
}

// Get camera/mic
async function getMedia() {
  try {
    myStream = await navigator.mediaDevices.getUserMedia({
      video: { width: 320, height: 240 },
      audio: true
    });
  } catch(err) {
    alert("Camera/mic error: " + err);
  }
}

// Initialize PeerJS
function initPeer(room) {
  myPeerId = room + '-' + Math.floor(Math.random()*1000);
  myPeer = new Peer(myPeerId, { debug: 2 });

  myPeer.on('open', id => {
    console.log("My Peer ID:", id);
    createVideo(myPeerId, myName, myStream);
    buttonsDiv.style.display = 'block';
    connectToRoom(room);
  });

  myPeer.on('call', call => {
    call.answer(myStream);
    const remoteId = call.peer;
    call.on('stream', stream => createVideo(remoteId, remoteId.split('-')[0], stream));
    call.on('close', () => removeVideo(remoteId));
    peers[remoteId] = call;
  });
}

// Connect to room
function connectToRoom(room) {
  const checkPeers = setInterval(() => {
    fetch('https://peerjs.com/peers')
      .then(res => res.json())
      .then(allPeers => {
        allPeers.forEach(id => {
          if(id.startsWith(room + '-') && !peers[id] && id !== myPeerId) {
            const call = myPeer.call(id, myStream);
            call.on('stream', stream => createVideo(id, id.split('-')[0], stream));
            call.on('close', () => removeVideo(id));
            peers[id] = call;
          }
        });
      })
      .catch(err => console.log(err));
  }, 3000);
}

// Join button
joinBtn.addEventListener('click', async () => {
  myName = nameInput.value.trim();
  const room = roomInput.value.trim();
  if(!myName || !room) return alert("Enter your name and room name");
  await getMedia();
  initPeer(room);
});

// Mute/unmute
muteBtn.addEventListener('click', () => {
  muted = !muted;
  myStream.getAudioTracks()[0].enabled = !muted;
  muteBtn.innerText = muted ? "Unmute" : "Mute";
});

// Leave room
leaveBtn.addEventListener('click', () => {
  for(let id in peers) peers[id].close();
  myPeer.destroy();
  videosDiv.innerHTML = '';
  buttonsDiv.style.display = 'none';
  alert("You left the room");
});
</script>
</body>
</html>
