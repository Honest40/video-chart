<!DOCTYPE html>
<html>
<head>
  <title>PeerJS Video Call with Username</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body { background:#0f172a; color:#fff; font-family:Arial; text-align:center; margin:0; padding:10px; }
    h2 { margin-top:5px; }
    video { width:45%; background:black; border-radius:12px; margin:5px; }
    .controls button { padding:10px 14px; margin:5px; font-size:15px; border:none; border-radius:8px; cursor:pointer; }
    .call { background:#22c55e; }
    .end { background:#ef4444; }
    .mute { background:#64748b; }
    .cam { background:#3b82f6; }
    input { padding:10px; width:200px; border-radius:6px; border:none; }
    .status { margin:10px; color:#38bdf8; }
  </style>
</head>
<body>

<h2>üìû Video & Audio Call (Username)</h2>

<input id="username" placeholder="Enter your username"><br>
<button onclick="setUsername()">Set Username</button>

<p>Your username: <b id="myId">Not set</b></p>

<input id="callName" placeholder="Enter username to call"><br>

<div class="controls">
  <button class="call" onclick="callUser()">üìû Call</button>
  <button class="end" onclick="endCall()">‚ùå End</button><br>
  <button class="mute" onclick="toggleMute()">üîá Mute</button>
  <button class="cam" onclick="toggleCamera()">üé• Camera</button>
</div>

<p class="status" id="status">Status: Idle</p>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script>
let peer;
let localStream;
let currentCall;
let micOn = true;
let camOn = true;
let myUsername = "";

/* ====== Set username ====== */
function setUsername() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("Enter a username!");
  
  myUsername = name;

  // Destroy previous peer if exists
  if (peer) peer.destroy();

  // Create PeerJS with username as ID
  peer = new Peer(myUsername, { debug: 2 });

  peer.on("open", id => {
    myId.innerText = id;
    status.innerText = "Status: Ready";
  });

  // Incoming call
  peer.on("call", call => {
    currentCall = call;
    call.answer(localStream);
    status.innerText = "Status: In call";

    call.on("stream", stream => remoteVideo.srcObject = stream);

    call.on("close", () => endCall());
  });

  // Get camera & mic
  navigator.mediaDevices.getUserMedia({ video:true, audio:true })
  .then(stream => {
    localStream = stream;
    localVideo.srcObject = stream;
  })
  .catch(err => alert("Camera error: " + err));
}

/* ====== Outgoing call ====== */
function callUser() {
  if (!peer) return alert("Set your username first!");
  const target = document.getElementById("callName").value.trim();
  if (!target) return alert("Enter username to call");

  currentCall = peer.call(target, localStream);
  status.innerText = "Status: Calling " + target;

  currentCall.on("stream", stream => {
    remoteVideo.srcObject = stream;
    status.innerText = "Status: In call with " + target;
  });

  currentCall.on("close", () => endCall());
}

/* ====== End call ====== */
function endCall() {
  if (currentCall) currentCall.close();
  remoteVideo.srcObject = null;
  status.innerText = "Status: Call ended";
}

/* ====== Mute / Unmute ====== */
function toggleMute() {
  micOn = !micOn;
  if (localStream) localStream.getAudioTracks()[0].enabled = micOn;
  status.innerText = micOn ? "Mic ON" : "Mic MUTED";
}

/* ====== Camera On / Off ====== */
function toggleCamera() {
  camOn = !camOn;
  if (localStream) localStream.getVideoTracks()[0].enabled = camOn;
  status.innerText = camOn ? "Camera ON" : "Camera OFF";
}
</script>

</body>
</html>
