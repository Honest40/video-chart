<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Free Multi-User Video Call</title>
<style>
body { font-family: Arial; text-align: center; background: #f0f0f0; margin: 0; padding: 0;}
#controls { margin: 20px; }
#videos { display: flex; flex-wrap: wrap; justify-content: center; }
.video-container { margin: 10px; display: flex; flex-direction: column; align-items: center; }
video { width: 300px; border-radius: 8px; border: 2px solid #333; }
label { margin-top: 5px; font-weight: bold; }
input, button { padding: 8px 12px; margin: 5px; font-size: 16px; }
</style>
</head>
<body>
<h2>Free Multi-User Video Call</h2>
<div id="controls">
  <input type="text" id="room-input" placeholder="Room name">
  <button id="join-btn">Join Room</button>
</div>
<div id="videos"></div>

<!-- PeerJS CDN -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const joinBtn = document.getElementById('join-btn');
const roomInput = document.getElementById('room-input');
const videosDiv = document.getElementById('videos');

let myStream;
let peers = {};
let myPeer;
let myPeerId;

// Helper: create video element
function createVideo(id, stream) {
  const container = document.createElement('div');
  container.className = 'video-container';
  container.id = 'container-' + id;

  const video = document.createElement('video');
  video.autoplay = true;
  video.playsInline = true;
  video.srcObject = stream;
  if(id === myPeerId) video.muted = true; // mute self

  const label = document.createElement('label');
  label.innerText = id;

  container.appendChild(video);
  container.appendChild(label);
  videosDiv.appendChild(container);
}

// Remove video element
function removeVideo(id) {
  const container = document.getElementById('container-' + id);
  if(container) container.remove();
}

// Get camera/mic
async function getMedia() {
  try {
    myStream = await navigator.mediaDevices.getUserMedia({
      video: { width: 320, height: 240 },
      audio: true
    });
  } catch(err) {
    alert("Camera/mic error: " + err);
  }
}

// Initialize PeerJS
function initPeer(room) {
  myPeerId = room + '-' + Math.floor(Math.random()*1000);
  myPeer = new Peer(myPeerId, { debug: 2 });

  myPeer.on('open', id => {
    console.log("My Peer ID:", id);
    createVideo(myPeerId, myStream);
    connectToRoom(room);
  });

  myPeer.on('call', call => {
    call.answer(myStream);
    const remoteId = call.peer;
    call.on('stream', stream => createVideo(remoteId, stream));
    call.on('close', () => removeVideo(remoteId));
    peers[remoteId] = call;
  });
}

// Connect to peers in room using PeerJS cloud
function connectToRoom(room) {
  const checkPeers = setInterval(() => {
    fetch('https://peerjs.com/peers')
      .then(res => res.json())
      .then(allPeers => {
        allPeers.forEach(id => {
          if(id.startsWith(room + '-') && !peers[id] && id !== myPeerId) {
            const call = myPeer.call(id, myStream);
            call.on('stream', stream => createVideo(id, stream));
            call.on('close', () => removeVideo(id));
            peers[id] = call;
          }
        });
      })
      .catch(err => console.log(err));
  }, 3000);
}

// Join room button
joinBtn.addEventListener('click', async () => {
  const room = roomInput.value.trim();
  if(!room) return alert("Enter a room name");
  await getMedia();
  initPeer(room);
});
</script>
</body>
</html>
